# Framework Genai
!pip install google-genai

# Framework ADK
!pip install -q google-adk

# Importar bibliotecas
import os
from google.colab import userdata
os.environ['GOOGLE_API_KEY'] = userdata.get('GOOGLE_API_KEY')
from google import genai

from google.adk.agents import Agent
from google.adk.runners import Runner
from google.adk.sessions import InMemorySessionService
from google.adk.tools import google_search

from google.genai import types # para criar conteÃºdos (content e part)
from datetime import date
import textwrap # para formatar melhor a saÃ­da do texto
from IPython.display import display, Markdown # para exibir texto formatado no colab
import requests # para fazer requisiÃ§Ãµes HTTP
import warnings
warnings.filterwarnings("ignore")

# FunÃ§Ã£o auxiliar que envia uma msg para um agente via runner e retorna a resposta final
def call_agent(agent: Agent, message_text: str) -> str:
  #cria um serviÃ§o de sessÃ£o em memÃ³ria
  session_service = InMemorySessionService()
  #cria uma nova sessÃ£o (vc pode personalizar os ids)
  session = session_service.create_session(app_name=agent.name,user_id="user1",session_id="session1")
  #cria um runner para o agente
  runner = Runner(agent=agent,app_name=agent.name,session_service=session_service)
  #cria o conteÃºdo da msg de entrada
  content = types.Content(role="user", parts=[types.Part(text=message_text)])

  final_response = ""
  #intera assincronamente pelos eventos retornados durante a execuÃ§Ã£o do agente
  for event in runner.run(user_id="user1",session_id="session1",new_message=content):
    if event.is_final_response():
      for part in event.content.parts:
        if part.text is not None:
          final_response += part.text
          final_response += "\n"
  return final_response

# funÃ§Ã£o auxiliar para exibir texto formatado no colab
def to_markdown(text):
  #text = text.replace("", "")
  return Markdown(textwrap.indent(text, '> ',predicate=lambda _:True))

#####################################
# Agente Buscador de Locais de SaÃºde
#####################################
def agente_buscador(promptTipo, promptEndereco, promptPlano, promptDetalhe, promptExtra):
  buscador = Agent(
      name = "agente_buscador",
      model = "gemini-2.0-flash",
      description = "Agente que busca informaÃ§Ãµes no Google",
      tools = [google_search],
      instruction = f"""
      VocÃª Ã© um assistente de pesquisa. A sua tarefa Ã© usar a ferramenta de pesquisa do Google (google_research)
      para encontrar locais de saÃºde para um paciente que precisa de uma {promptTipo}.
      Foque em no mÃ¡ximo 9 locais mais prÃ³ximos, ordenando por proximidade, com base no endereÃ§o {promptEndereco}.
      e que aceitem o plano de saÃºde do paciente, se for informado, senÃ£o liste somente locais de saÃºde da rede pÃºblica e privada.
      Sobre o plano de saÃºde o paciente informou: {promptPlano}.
      Se o paciente informou um plano de saÃºde e se nÃ£o houver locais de saÃºde que aceitem o plano de saÃºde
      prÃ³ximos a 5km do endereÃ§o, informe tambÃ©m os locais de saÃºde da rede pÃºblica.
      AlÃ©m disso, os locais de saÃºde precisam atender os detalhes sobre a especialidade mÃ©dica ou problema de saÃºde
      informados pelo paciente: {promptDetalhe}.
      VocÃª nÃ£o deve perguntar nada, nem pedir mais informaÃ§Ãµes, mesmo se o paciente esquecer de informar algo. 
      NÃ£o deve nem pedir confirmaÃ§Ã£o para dar uma resposta. 
      Trabalhe apenas com as informaÃ§Ãµes fornecidas para sempre oferecer uma resposta mesmo que seja insuficiente.
      E ao final da resposta, ofereÃ§a a opÃ§Ã£o de exportar ou compartilhar esse texto.
      VocÃª deve tambÃ©m usar o @Google Maps (google_maps) para mostrar o link da localizaÃ§Ã£o de cada local de saÃºde.
      Tendo o cuidado para nÃ£o mostrar link que nÃ£o sejam vÃ¡lidos. 
      Ou seja, os links do google maps precisam estar funcionando para cada local.
      ####
      A resposta precisa ser clara e direta, como se falasse para uma pessoa que estÃ¡ com muita pressa, usado o seguinte formato:

      Locais de SaÃºde que aceitam o plano de saÃºde:
      - Local 1: telefone (endereÃ§o) - link do Local 1 no Google Maps
      - Local 2: telefone (endereÃ§o) - link do Local 2 no Google Maps
      - Local 3: telefone (endereÃ§o) - link do Local 3 no Google Maps

      Locais de SaÃºde da rede pÃºblica:
      - Local 4: telefone (endereÃ§o) - link do Local 4 no Google Maps
      - Local 5: telefone (endereÃ§o) - link do Local 5 no Google Maps
      - Local 6: telefone (endereÃ§o) - link do Local 6 no Google Maps

      Locais de SaÃºde da privada:
      - Local 7: telefone (endereÃ§o) - link do Local 7 no Google Maps
      - Local 8: telefone (endereÃ§o) - link do Local 8 no Google Maps
      - Local 9: telefone (endereÃ§o) - link do Local 9 no Google Maps

      RecomendaÃ§Ãµes:
      - recomendaÃ§Ã£o 1
      - recomendaÃ§Ã£o 2
      - recomendaÃ§Ã£o 3

      ####
      """
  )
  if not promptExtra:
    entrada_do_agente_buscador = f"O paciente nÃ£o ficou satisfeito com a Ãºltima resposta, e pediu o seguinte: {promptExtra}"
  else:
    entrada_do_agente_buscador = ""

  resposta = call_agent(buscador,entrada_do_agente_buscador)

  return resposta

  

##########################
# chatbot Agentes de SaÃºde
##########################
promptFinal = "1"

while promptFinal != "2":

  print("\nğŸ§‘â€âš•ï¸Agente de SaÃºde: OlÃ¡, estou pronto para buscar locais de saÃºde mais prÃ³ximos e adequados para vocÃª ou alguÃ©m que vocÃª deseja cuidar.\n\nQual Ã© necessidade do paciente?\n")
  print("1 - EmergÃªncia mÃ©dica\n2 - Consulta mÃ©dica\n3 - Outros serviÃ§os mÃ©dicos\n")
  prompt = input("ğŸ™‹Paciente: ")

  while (prompt != "1" and prompt != "2" and prompt != "3"):
    print("\nğŸ§‘â€âš•ï¸Agente de SaÃºde: Por favor, informe uma opÃ§Ã£o vÃ¡lida.\n")
    print("1 - EmergÃªncia mÃ©dica\n2 - Consulta mÃ©dica\n3 - Outros serviÃ§os mÃ©dicos\n")
    prompt = input("ğŸ™‹Paciente: ")
    
  if prompt == "1":
    promptTipo = "emergÃªncia mÃ©dica"
    print("\nğŸ§‘â€âš•ï¸Agente de SaÃºde: Em uma emergÃªncia mÃ©dica Ã© normal ficarmos nervosos, mas fique tranquilo que iremos ajudar rapidamente...")
  else:
    if prompt == "2":
      promptTipo = "consulta mÃ©dica"
      print("\nğŸ§‘â€âš•ï¸Agente de SaÃºde: Ã“timo, uma consulta mÃ©dica Ã© sinal de cuidado e atenÃ§Ã£o com o paciente e sua famÃ­lia...")
    else:
      promptTipo = "outros serviÃ§os mÃ©dicos"
      print("\nğŸ§‘â€âš•ï¸Agente de SaÃºde: Compreendo que hÃ¡ outros serviÃ§os mÃ©dicos como exames, procedimetos, etc... Deseja expecificar qual serviÃ§o?\n")
      prompt = input("ğŸ™‹Paciente: ")
      if prompt:
        promptTipo = promptTipo + prompt

  print("\nğŸ§‘â€âš•ï¸Agente de SaÃºde: Qual especialidade mÃ©dica ou problema de saÃºde?\n")
  promptDetalhe = input("ğŸ™‹Paciente:")

  while not promptDetalhe:
    print("\nğŸ§‘â€âš•ï¸Agente de SaÃºde: Qual especialidade mÃ©dica ou problema de saÃºde?\n")
    promptEndereco = input("ğŸ™‹Paciente:") 

  print("\nğŸ§‘â€âš•ï¸Agente de SaÃºde: Qual seria a localidade (cidade/rua/bairro)?\n")
  promptEndereco = input("ğŸ™‹Paciente:")

  while not promptEndereco:
    print("\nğŸ§‘â€âš•ï¸Agente de SaÃºde: Precisamos ao menos da rua e cidade.\n")
    promptEndereco = input("ğŸ™‹Paciente:") 

  print("\nğŸ§‘â€âš•ï¸Agente de SaÃºde: O paciente tem plano de saÃºde? Se sim, informe qual.\n")
  promptPlano = input("ğŸ™‹Paciente:")

  print(f"\nğŸ§‘â€âš•ï¸Agente de SaÃºde: Pronto, agora iremos buscar os locais de saÃºde de {promptTipo} de acordo com as suas informaÃ§Ãµes.\n\n")
  
  promptExtra = ""

  while promptExtra != "1":
    resposta = agente_buscador(promptTipo,promptEndereco,promptPlano,promptDetalhe,promptExtra)
    print("\nğŸ¥Segue o resultado: \n\n")
    display(to_markdown(resposta))
    print("\n\n----------------------------------------------\n\n")
    print("\nğŸ§‘â€âš•ï¸Agente de SaÃºde: Consegui te atender?\n")
    print("1 - Sim\n2 - NÃ£o\n")
    promptExtra = input("ğŸ™‹Paciente: ")
    while promptExtra != "1" and promptExtra != "2":
      print("\nğŸ§‘â€âš•ï¸Agente de SaÃºde: Consegui te atender?\n")
      print("1 - Sim\n2 - NÃ£o\n")
      promptExtra = input("ğŸ™‹Paciente:") 
    if promptExtra == "1":
      break
    print("\nğŸ§‘â€âš•ï¸Agente de SaÃºde: Quer fazer um novo atendimento?\n")
    print("1 - Sim\n2 - NÃ£o\n")
    promptExtra = input("ğŸ™‹Paciente: ") 
    while promptExtra != "1" and promptExtra != "2":
      print("\nğŸ§‘â€âš•ï¸Agente de SaÃºde: Quer fazer um novo atendimento?\n")
      print("1 - Sim\n2 - NÃ£o\n")
      promptExtra = input("ğŸ™‹Paciente:") 
    if promptExtra == "1":
      promptFinal = "0"
      break
    print("\nğŸ§‘â€âš•ï¸Agente de SaÃºde: Compreendo, vou continuar aqui neste atendimento para te ajudar. Informe mais o que o paciente precisa...\n")
    promptExtra = input("ğŸ™‹Paciente: ")
    while not promptExtra:
      print("\nğŸ§‘â€âš•ï¸Agente de SaÃºde: Informe mais o que o paciente precisa...\n")
      promptEndereco = input("ğŸ™‹Paciente:") 


  if promptFinal == "1":
    print("\nğŸ§‘â€âš•ï¸Agente de SaÃºde: Quer fazer um novo atendimento?\n")
    print("1 - Sim\n2 - NÃ£o\n")
    promptFinal = input("ğŸ™‹Paciente: ")
    if promptFinal == "2":
      print("\nğŸ§‘â€âš•ï¸Agente de SaÃºde: Tchau! Muita saÃºde e paz!")
      break
  else:
    promptFinal = "1"


